<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <title>è·ŸæŠ•åŠ©æ‰‹</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="config.js"></script>
    <style>
      :root {
        /* æµ…è‰²ä¸»é¢˜ä¼˜åŒ–ï¼šé«˜å¯¹æ¯”ä½†ä¸åˆºçœ¼ */
        --bg: #f5f7fb; /* é¡µé¢èƒŒæ™¯ */
        --card: #ffffff; /* å¡ç‰‡èƒŒæ™¯ */
        --text: #0f172a; /* ä¸»æ–‡å­— */
        --muted: #667085; /* æ¬¡çº§æ–‡å­— */
        --border: #e6e8ef; /* è¾¹æ¡† */
        --accent: #3b82f6; /* å¼ºè°ƒè‰² */
        --accent-weak: #eef4ff;
        --accent-border: #dbe7ff;
        --soft: #f8fafc; /* è½»åº•è‰² */
        --shadow: 0 6px 24px rgba(15, 23, 42, 0.06);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto,
          Helvetica, Arial;
      }
      .wrap {
        max-width: 1500px;
        margin: 28px auto 56px;
        padding: 0 16px;
      }
      h1 {
        margin: 0 0 14px;
        font-size: 20px;
        letter-spacing: 0.2px;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: var(--shadow);
        padding: 14px;
      }
      .row {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 10px;
        align-items: end;
      }
      .label {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 6px;
      }
      input[type="number"],
      input[type="text"] {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: #fff;
        color: var(--text);
        outline: none;
      }
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--soft);
        cursor: pointer;
        user-select: none;
        font-size: 14px;
      }
      .btn:hover {
        border-color: #cfd5e2;
      }
      .btn-danger {
        background: #fff1f2;
        border-color: #fecdd3;
        color: #b91c1c;
      }
      .toolbar {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .pill {
        background: #f4f6fb;
        border: 1px solid var(--border);
        padding: 8px 12px;
        border-radius: 10px;
        font-variant-numeric: tabular-nums;
      }
      .muted {
        color: var(--muted);
      }
      .right {
        text-align: right;
      }
      .num {
        font-variant-numeric: tabular-nums;
      }
      .hr {
        height: 1px;
        background: var(--border);
        margin: 12px 0;
      }
      /* è¡¨æ ¼ */
      .grid-head,
      .grid-row {
        display: grid;
        grid-template-columns: 40px 3fr 1.3fr 1.1fr 1.4fr 1.3fr 1.1fr 1.3fr 90px;
        gap: 8px;
        align-items: center;
      }
      .grid-head {
        font-size: 12px;
        color: var(--muted);
        padding: 8px 0;
        border-bottom: 1px solid var(--border);
      }
      .grid-row {
        padding: 8px 0;
        border-bottom: 1px dashed #eef2f7;
      }
      .grid-row:nth-child(odd) {
        background: #fff;
      }
      .grid-row:nth-child(even) {
        background: #fcfdff;
      }
      /* æ€»ç»“æ¡ */
      .summary {
        margin-top: 10px;
        padding: 10px 12px;
        border: 1px solid var(--border);
        background: #fafbff;
        border-radius: 10px;
        display: flex;
        gap: 14px;
        flex-wrap: wrap;
        align-items: center;
      }
      .badge {
        padding: 4px 8px;
        border-radius: 999px;
        background: var(--accent-weak);
        color: #1d4ed8;
        border: 1px solid var(--accent-border);
        font-size: 12px;
      }
      .summary-item {
        display: flex;
        gap: 6px;
        align-items: center;
      }
      .summary-key {
        color: #334155;
      }
      /* è½»æç¤º */
      .toast {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: 22px;
        background: #111827;
        color: #fff;
        padding: 9px 12px;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        display: none;
      }
      .toast.show {
        display: block;
      }
      /* é¢œè‰²åˆ‡æ¢æŒ‰é’®æ ·å¼ */
      .color-toggle {
        width: 28px;
        height: 28px;
        border: 2px solid var(--border);
        border-radius: 50%;
        cursor: pointer;
        outline: none;
        background: transparent;
        position: relative;
        transition: all 0.2s ease;
      }
      .color-toggle:hover {
        transform: scale(1.1);
        border-color: var(--accent);
      }
      .color-toggle.red {
        background: #ef4444;
        border-color: #dc2626;
      }
      .color-toggle.green {
        background: #22c55e;
        border-color: #16a34a;
      }
      .color-toggle.blue {
        background: #3b82f6;
        border-color: #2563eb;
      }
      .color-toggle.transparent {
        background: transparent;
        border-color: var(--border);
      }
    </style>
  </head>
  <body>
    <div id="app" class="wrap">
      <div class="card" style="margin-bottom: 12px">
        <div class="row">
          <div style="grid-column: span 4">
            <div class="label">å¤§ä½¬æ€»ä»“ä½ï¼ˆå…ƒï¼‰</div>
            <input
              type="number"
              min="0"
              step="0.01"
              v-model.number="state.bigTotal"
            />
          </div>
          <div style="grid-column: span 4">
            <div class="label">æˆ‘çš„æ€»ä»“ä½ï¼ˆå…ƒï¼‰</div>
            <input
              type="number"
              min="0"
              step="0.01"
              v-model.number="state.myTotal"
            />
          </div>
          <div style="grid-column: span 4">
            <div class="label">æ“ä½œ</div>
            <div class="toolbar">
              <button class="btn" @click="addRow">â• æ–°å¢</button>
              <button class="btn" @click="copyConfig">ğŸ“‹ å¤åˆ¶é…ç½®</button>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row" style="align-items: center">
          <div style="grid-column: span 3">
            <div class="label">å½“å‰å¤§ä½¬æ€»æŠ•å…¥ï¼ˆå…ƒï¼‰</div>
            <div class="pill num">{{ fmt(sumAmount) }}</div>
          </div>
          <div style="grid-column: span 3">
            <div class="label">å¤§ä½¬ä»“ä½å æ¯”ï¼š</div>
            <div class="pill num">{{ pct(totalPercentOfBig) }}</div>
          </div>
          <div style="grid-column: span 3">
            <div class="label">æ¯”ä¾‹ï¼ˆå¤§ä½¬ / æˆ‘ï¼‰</div>
            <div class="pill num">{{ ratioText }}</div>
          </div>
          <div style="grid-column: span 3">
            <div class="label">æˆ‘åº”æŠ•å…¥åˆè®¡ï¼ˆå…ƒï¼‰</div>
            <div class="pill num">{{ fmt(totalShouldInvest) }}</div>
          </div>
        </div>
      </div>

      <!-- è¡¨æ ¼ -->
      <div class="card">
        <div class="grid-head">
          <div>é¢œè‰²</div>
          <div>æŒä»“æ˜ç»†</div>
          <div class="right">é‡‘é¢</div>
          <div class="right">å æ¯”</div>
          <div class="right">æˆ‘åº”æŠ•å…¥</div>
          <div class="right">æˆ‘ç›®å‰æŠ•å…¥</div>
          <div class="right">æŠ•å…¥å æ¯”</div>
          <div class="right">å¾…è¡¥é‡‘é¢</div>
          <div class="right">æ“ä½œ</div>
        </div>

        <div
          v-for="(row, i) in sortedRows"
          :key="row.id"
          class="grid-row"
          :style="row.color ? { backgroundColor: hexToRgba(row.color, 0.1) } : {}"
        >
          <button
            class="color-toggle"
            :class="getColorClass(row.color)"
            @click="toggleColor(row)"
            :title="getColorTitle(row.color)"
          ></button>
          <input type="text" v-model="row.name" placeholder="åç§°" />
          <input
            class="right"
            type="number"
            min="0"
            step="0.01"
            v-model.number="row.amount"
          />
          <div class="right num">{{ pct(rowPercent(row)) }}</div>
          <div class="right num">{{ fmt(shouldInvest(row)) }}</div>
          <input
            class="right"
            type="number"
            min="0"
            step="0.01"
            v-model.number="row.currentInvest"
            placeholder="å½“å‰æŠ•å…¥"
          />
          <div class="right num">{{ pct(currentInvestPercent(row)) }}</div>
          <div class="right num">{{ fmt(toFillAmount(row)) }}</div>
          <div class="right">
            <button class="btn btn-danger" @click="removeRow(i)">åˆ é™¤</button>
          </div>
        </div>

        <div class="hr"></div>

        <!-- æ€»ç»“ï¼ˆå•è¡Œå››é¡¹ï¼‰ -->
        <div class="summary">
          <span class="badge">æ€»ç»“</span>
          <span class="summary-item"
            ><span class="summary-key">å¤§ä½¬æ€»æŠ•å…¥ï¼š</span
            ><b class="num">{{ fmt(sumAmount) }} å…ƒ</b></span
          >
          <span class="summary-item"
            ><span class="summary-key">æˆ‘æ€»æŠ•å…¥ï¼š</span
            ><b class="num">{{ fmt(totalShouldInvest) }} å…ƒ</b></span
          >
          <span class="summary-item"
            ><span class="summary-key">æ€»å¾…è¡¥ï¼š</span
            ><b class="num">{{ fmt(totalToFill) }} å…ƒ</b></span
          >
        </div>
      </div>

      <!-- è½»æç¤º -->
      <div class="toast" :class="{show: toast.show}">{{ toast.msg }}</div>
    </div>

    <script>
      const { createApp, reactive, computed, ref } = Vue;

      createApp({
        setup() {
          // é»˜è®¤ç¤ºä¾‹
          const demoRows = () => [
            {
              id: crypto.randomUUID(),
              name: "å˜‰å®ä¸Šè¯ç§‘åˆ›æ¿èŠ¯ç‰‡ ETF è”æ¥ C",
              amount: 62922,
              currentInvest: 0,
              toFill: 629.22,
            },
            {
              id: crypto.randomUUID(),
              name: "æ°¸èµ¢å…ˆè¿›åˆ¶é€ æ™ºé€‰æ··åˆ C",
              amount: 63448,
              currentInvest: 0,
              toFill: 634.48,
            },
            {
              id: crypto.randomUUID(),
              name: "å¾·é‚¦åŠå¯¼ä½“äº§ä¸šæ··åˆ C",
              amount: 19440,
              currentInvest: 0,
              toFill: 194.4,
            },
            {
              id: crypto.randomUUID(),
              name: "åå¤æ’ç”Ÿç§‘æŠ€ ETF è”æ¥ï¼ˆQDIIï¼‰C",
              amount: 89870,
              currentInvest: 0,
              toFill: 898.7,
            },
            {
              id: crypto.randomUUID(),
              name: "åšæ—¶ä¸­è¯æœºå™¨äººæŒ‡æ•° C",
              amount: 25169,
              currentInvest: 0,
              toFill: 251.69,
            },
            {
              id: crypto.randomUUID(),
              name: "å¤©å¼˜åˆ›ä¸šæ¿ ETF è”æ¥ C",
              amount: 18821,
              currentInvest: 0,
              toFill: 188.21,
            },
            {
              id: crypto.randomUUID(),
              name: "æ˜“æ–¹è¾¾ç§‘åˆ› 50 è”æ¥ C",
              amount: 19769,
              currentInvest: 0,
              toFill: 197.69,
            },
            {
              id: crypto.randomUUID(),
              name: "å¾·é‚¦ç¨³ç›ˆå¢é•¿çµæ´»é…ç½®æ··åˆ C",
              amount: 2000,
              currentInvest: 0,
              toFill: 20,
            },
            {
              id: crypto.randomUUID(),
              name: "æ°¸èµ¢ä¿¡æ¯äº§ä¸šæ™ºé€‰æ··åˆ C",
              amount: 2000,
              currentInvest: 0,
              toFill: -1980,
            },
            {
              id: crypto.randomUUID(),
              name: "åŒ—ä¿¡ç‘ä¸°äº§ä¸šå‡çº§å¤šç­–ç•¥æ··åˆå‹",
              amount: 9000,
              currentInvest: 0,
              toFill: 90,
            },
          ];

          const cfg =
            window.followConfig && typeof window.followConfig === "object"
              ? window.followConfig
              : null;

          const state = reactive({
            bigTotal: cfg?.bigTotal ?? 350000,
            myTotal: cfg?.myTotal ?? 3500,
            rows: (cfg?.rows ?? demoRows())
              .map((r) => ({
                id: crypto.randomUUID(),
                name: String(r.name ?? ""),
                amount: Number(r.amount) || 0,
                currentInvest: Number(r.currentInvest) || 0,
                color: String(r.color ?? ""),
                toFill: isFinite(r.toFill) ? Number(r.toFill) : null,
              }))
              .sort((a, b) => {
                // åˆå§‹åŒ–æ—¶æŒ‰å æ¯”ä»å¤§åˆ°å°æ’åºä¸€æ¬¡
                const percentA =
                  (Number(a.amount) || 0) / (cfg?.bigTotal ?? 350000);
                const percentB =
                  (Number(b.amount) || 0) / (cfg?.bigTotal ?? 350000);
                return percentB - percentA;
              }),
          });

          // è®¡ç®—
          const sumAmount = computed(() =>
            state.rows.reduce((s, r) => s + (Number(r.amount) || 0), 0)
          );
          const totalPercentOfBig = computed(() =>
            state.bigTotal > 0 ? sumAmount.value / state.bigTotal : 0
          );
          const ratio = computed(() =>
            state.myTotal > 0 ? state.bigTotal / state.myTotal : null
          );
          const ratioText = computed(() =>
            ratio.value ? ratio.value.toFixed(2) : "â€”"
          );

          const rowPercent = (row) => {
            const amt = Number(row.amount) || 0;
            return state.bigTotal > 0 ? amt / state.bigTotal : 0;
          };
          // æˆ‘åº”æŠ•å…¥ = å¤§ä½¬è¯¥ä»“ä½é‡‘é¢ Ã· å€ç‡
          const shouldInvest = (row) =>
            !ratio.value ? 0 : (Number(row.amount) || 0) / ratio.value;
          // æŠ•å…¥å æ¯” = æˆ‘ç›®å‰æŠ•å…¥ Ã· æˆ‘çš„æ€»ä»“ä½
          const currentInvestPercent = (row) => {
            const currentInvest = Number(row.currentInvest) || 0;
            return state.myTotal > 0 ? currentInvest / state.myTotal : 0;
          };
          // å¾…è¡¥é‡‘é¢ = æˆ‘åº”æŠ•å…¥ - æˆ‘ç›®å‰æŠ•å…¥
          const toFillAmount = (row) =>
            shouldInvest(row) - (Number(row.currentInvest) || 0);
          const totalShouldInvest = computed(() =>
            state.rows.reduce((s, r) => s + shouldInvest(r), 0)
          );
          const totalCurrentInvest = computed(() =>
            state.rows.reduce((s, r) => s + (Number(r.currentInvest) || 0), 0)
          );
          const totalToFill = computed(() =>
            state.rows.reduce((s, r) => s + toFillAmount(r), 0)
          );

          // æ“ä½œ
          const addRow = () => {
            state.rows.push({
              id: crypto.randomUUID(),
              name: "",
              amount: 0,
              currentInvest: 0,
              color: "",
              toFill: null,
            });
          };
          const removeRow = (i) => {
            const sortedRow = sortedRows.value[i];
            const originalIndex = state.rows.findIndex(
              (r) => r.id === sortedRow.id
            );
            const row = state.rows[originalIndex];
            const name = row.name || `ç¬¬${i + 1}è¡Œ`;
            if (confirm(`ç¡®å®šè¦åˆ é™¤"${name}"å—ï¼Ÿ`)) {
              state.rows.splice(originalIndex, 1);
            }
          };

          // ç›´æ¥è¿”å›åŸå§‹è¡Œæ•°æ®ï¼Œä¸è¿›è¡ŒåŠ¨æ€æ’åº
          const sortedRows = computed(() => {
            return state.rows;
          });

          // é¢œè‰²ç›¸å…³å‡½æ•°
          const colorCycle = ["", "#ef4444", "#22c55e", "#3b82f6"]; // é€æ˜ã€çº¢ã€ç»¿ã€è“

          const toggleColor = (row) => {
            const currentIndex = colorCycle.indexOf(row.color);
            const nextIndex = (currentIndex + 1) % colorCycle.length;
            row.color = colorCycle[nextIndex];
          };

          const getColorClass = (color) => {
            switch (color) {
              case "#ef4444":
                return "red";
              case "#22c55e":
                return "green";
              case "#3b82f6":
                return "blue";
              default:
                return "transparent";
            }
          };

          const getColorTitle = (color) => {
            switch (color) {
              case "#ef4444":
                return "çº¢è‰²";
              case "#22c55e":
                return "ç»¿è‰²";
              case "#3b82f6":
                return "è“è‰²";
              default:
                return "é€æ˜";
            }
          };

          const hexToRgba = (hex, alpha = 1) => {
            if (!hex) return "transparent";
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
          };

          // å¤åˆ¶é…ç½®ï¼ˆJS ç‰‡æ®µï¼Œç›´æ¥ç²˜åˆ°ä½ çš„ä»£ç é‡Œï¼‰
          const toast = reactive({ show: false, msg: "" });
          const showToast = (msg) => {
            toast.msg = msg;
            toast.show = true;
            setTimeout(() => (toast.show = false), 1300);
          };
          const copyConfig = async () => {
            const payload = {
              bigTotal: state.bigTotal,
              myTotal: state.myTotal,
              rows: state.rows.map((r) => ({
                name: r.name,
                amount: Number(r.amount) || 0,
                currentInvest: Number(r.currentInvest) || 0,
                color: r.color || "",
                toFill: isFinite(r.toFill) ? Number(r.toFill) : null,
              })),
              version: 3,
            };
            const jsSnippet = `
window.followConfig = ${JSON.stringify(payload, null, 2)};`;
            try {
              await navigator.clipboard.writeText(jsSnippet);
              showToast("å·²å¤åˆ¶ JS é…ç½®åˆ°å‰ªè´´æ¿");
            } catch (e) {
              const ta = document.createElement("textarea");
              ta.value = jsSnippet;
              document.body.appendChild(ta);
              ta.select();
              document.execCommand("copy");
              ta.remove();
              showToast("å·²å¤åˆ¶ JS é…ç½®ï¼ˆå…¼å®¹æ¨¡å¼ï¼‰");
            }
          };

          // å·¥å…·
          const nf = new Intl.NumberFormat("zh-CN", {
            maximumFractionDigits: 2,
          });
          const pf = new Intl.NumberFormat("zh-CN", {
            style: "percent",
            maximumFractionDigits: 2,
          });
          const fmt = (n) => nf.format(Number(n || 0));
          const pct = (p) => pf.format(Math.max(0, p || 0));

          return {
            state,
            sumAmount,
            totalPercentOfBig,
            ratioText,
            totalShouldInvest,
            totalCurrentInvest,
            totalToFill,
            rowPercent,
            shouldInvest,
            currentInvestPercent,
            toFillAmount,
            sortedRows,
            addRow,
            removeRow,
            toggleColor,
            getColorClass,
            getColorTitle,
            hexToRgba,
            copyConfig,
            toast,
            fmt,
            pct,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
