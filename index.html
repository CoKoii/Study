<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <title>跟投助手</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="config.js"></script>
    <style>
      :root {
        /* 浅色主题优化：高对比但不刺眼 */
        --bg: #f5f7fb; /* 页面背景 */
        --card: #ffffff; /* 卡片背景 */
        --text: #0f172a; /* 主文字 */
        --muted: #667085; /* 次级文字 */
        --border: #e6e8ef; /* 边框 */
        --accent: #3b82f6; /* 强调色 */
        --accent-weak: #eef4ff;
        --accent-border: #dbe7ff;
        --soft: #f8fafc; /* 轻底色 */
        --shadow: 0 6px 24px rgba(15, 23, 42, 0.06);
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto,
          Helvetica, Arial;
      }
      .wrap {
        max-width: 1500px;
        margin: 28px auto 56px;
        padding: 0 16px;
      }
      h1 {
        margin: 0 0 14px;
        font-size: 20px;
        letter-spacing: 0.2px;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: var(--shadow);
        padding: 14px;
      }
      .row {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 10px;
        align-items: end;
      }
      .label {
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 6px;
      }
      input[type="number"],
      input[type="text"] {
        width: 100%;
        padding: 8px 10px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: #fff;
        color: var(--text);
        outline: none;
      }
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: var(--soft);
        cursor: pointer;
        user-select: none;
        font-size: 14px;
      }
      .btn:hover {
        border-color: #cfd5e2;
      }
      .btn-danger {
        background: #fff1f2;
        border-color: #fecdd3;
        color: #b91c1c;
      }
      .toolbar {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .pill {
        background: #f4f6fb;
        border: 1px solid var(--border);
        padding: 8px 12px;
        border-radius: 10px;
        font-variant-numeric: tabular-nums;
      }
      .muted {
        color: var(--muted);
      }
      .right {
        text-align: right;
      }
      .num {
        font-variant-numeric: tabular-nums;
      }
      .hr {
        height: 1px;
        background: var(--border);
        margin: 12px 0;
      }
      /* 表格 */
      .grid-head,
      .grid-row {
        display: grid;
        grid-template-columns: 40px 3fr 1.3fr 1.1fr 1.4fr 1.3fr 1.1fr 1.3fr 90px;
        gap: 8px;
        align-items: center;
      }
      .grid-head {
        font-size: 12px;
        color: var(--muted);
        padding: 8px 0;
        border-bottom: 1px solid var(--border);
      }
      .grid-row {
        padding: 8px 0;
        border-bottom: 1px dashed #eef2f7;
      }
      .grid-row:nth-child(odd) {
        background: #fff;
      }
      .grid-row:nth-child(even) {
        background: #fcfdff;
      }
      /* 总结条 */
      .summary {
        margin-top: 10px;
        padding: 10px 12px;
        border: 1px solid var(--border);
        background: #fafbff;
        border-radius: 10px;
        display: flex;
        gap: 14px;
        flex-wrap: wrap;
        align-items: center;
      }
      .badge {
        padding: 4px 8px;
        border-radius: 999px;
        background: var(--accent-weak);
        color: #1d4ed8;
        border: 1px solid var(--accent-border);
        font-size: 12px;
      }
      .summary-item {
        display: flex;
        gap: 6px;
        align-items: center;
      }
      .summary-key {
        color: #334155;
      }
      /* 轻提示 */
      .toast {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: 22px;
        background: #111827;
        color: #fff;
        padding: 9px 12px;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        display: none;
      }
      .toast.show {
        display: block;
      }
      /* 颜色切换按钮样式 */
      .color-toggle {
        width: 28px;
        height: 28px;
        border: 2px solid var(--border);
        border-radius: 50%;
        cursor: pointer;
        outline: none;
        background: transparent;
        position: relative;
        transition: all 0.2s ease;
      }
      .color-toggle:hover {
        transform: scale(1.1);
        border-color: var(--accent);
      }
      .color-toggle.red {
        background: #ef4444;
        border-color: #dc2626;
      }
      .color-toggle.green {
        background: #22c55e;
        border-color: #16a34a;
      }
      .color-toggle.blue {
        background: #3b82f6;
        border-color: #2563eb;
      }
      .color-toggle.transparent {
        background: transparent;
        border-color: var(--border);
      }
    </style>
  </head>
  <body>
    <div id="app" class="wrap">
      <div class="card" style="margin-bottom: 12px">
        <div class="row">
          <div style="grid-column: span 4">
            <div class="label">大佬总仓位（元）</div>
            <input
              type="number"
              min="0"
              step="0.01"
              v-model.number="state.bigTotal"
            />
          </div>
          <div style="grid-column: span 4">
            <div class="label">我的总仓位（元）</div>
            <input
              type="number"
              min="0"
              step="0.01"
              v-model.number="state.myTotal"
            />
          </div>
          <div style="grid-column: span 4">
            <div class="label">操作</div>
            <div class="toolbar">
              <button class="btn" @click="addRow">➕ 新增</button>
              <button class="btn" @click="copyConfig">📋 复制配置</button>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row" style="align-items: center">
          <div style="grid-column: span 3">
            <div class="label">当前大佬总投入（元）</div>
            <div class="pill num">{{ fmt(sumAmount) }}</div>
          </div>
          <div style="grid-column: span 3">
            <div class="label">大佬仓位占比：</div>
            <div class="pill num">{{ pct(totalPercentOfBig) }}</div>
          </div>
          <div style="grid-column: span 3">
            <div class="label">比例（大佬 / 我）</div>
            <div class="pill num">{{ ratioText }}</div>
          </div>
          <div style="grid-column: span 3">
            <div class="label">我应投入合计（元）</div>
            <div class="pill num">{{ fmt(totalShouldInvest) }}</div>
          </div>
        </div>
      </div>

      <!-- 表格 -->
      <div class="card">
        <div class="grid-head">
          <div>颜色</div>
          <div>持仓明细</div>
          <div class="right">金额</div>
          <div class="right">占比</div>
          <div class="right">我应投入</div>
          <div class="right">我目前投入</div>
          <div class="right">投入占比</div>
          <div class="right">待补金额</div>
          <div class="right">操作</div>
        </div>

        <div
          v-for="(row, i) in sortedRows"
          :key="row.id"
          class="grid-row"
          :style="row.color ? { backgroundColor: hexToRgba(row.color, 0.1) } : {}"
        >
          <button
            class="color-toggle"
            :class="getColorClass(row.color)"
            @click="toggleColor(row)"
            :title="getColorTitle(row.color)"
          ></button>
          <input type="text" v-model="row.name" placeholder="名称" />
          <input
            class="right"
            type="number"
            min="0"
            step="0.01"
            v-model.number="row.amount"
          />
          <div class="right num">{{ pct(rowPercent(row)) }}</div>
          <div class="right num">{{ fmt(shouldInvest(row)) }}</div>
          <input
            class="right"
            type="number"
            min="0"
            step="0.01"
            v-model.number="row.currentInvest"
            placeholder="当前投入"
          />
          <div class="right num">{{ pct(currentInvestPercent(row)) }}</div>
          <div class="right num">{{ fmt(toFillAmount(row)) }}</div>
          <div class="right">
            <button class="btn btn-danger" @click="removeRow(i)">删除</button>
          </div>
        </div>

        <div class="hr"></div>

        <!-- 总结（单行四项） -->
        <div class="summary">
          <span class="badge">总结</span>
          <span class="summary-item"
            ><span class="summary-key">大佬总投入：</span
            ><b class="num">{{ fmt(sumAmount) }} 元</b></span
          >
          <span class="summary-item"
            ><span class="summary-key">我总投入：</span
            ><b class="num">{{ fmt(totalShouldInvest) }} 元</b></span
          >
          <span class="summary-item"
            ><span class="summary-key">总待补：</span
            ><b class="num">{{ fmt(totalToFill) }} 元</b></span
          >
        </div>
      </div>

      <!-- 轻提示 -->
      <div class="toast" :class="{show: toast.show}">{{ toast.msg }}</div>
    </div>

    <script>
      const { createApp, reactive, computed, ref } = Vue;

      createApp({
        setup() {
          // 默认示例
          const demoRows = () => [
            {
              id: crypto.randomUUID(),
              name: "嘉实上证科创板芯片 ETF 联接 C",
              amount: 62922,
              currentInvest: 0,
              toFill: 629.22,
            },
            {
              id: crypto.randomUUID(),
              name: "永赢先进制造智选混合 C",
              amount: 63448,
              currentInvest: 0,
              toFill: 634.48,
            },
            {
              id: crypto.randomUUID(),
              name: "德邦半导体产业混合 C",
              amount: 19440,
              currentInvest: 0,
              toFill: 194.4,
            },
            {
              id: crypto.randomUUID(),
              name: "华夏恒生科技 ETF 联接（QDII）C",
              amount: 89870,
              currentInvest: 0,
              toFill: 898.7,
            },
            {
              id: crypto.randomUUID(),
              name: "博时中证机器人指数 C",
              amount: 25169,
              currentInvest: 0,
              toFill: 251.69,
            },
            {
              id: crypto.randomUUID(),
              name: "天弘创业板 ETF 联接 C",
              amount: 18821,
              currentInvest: 0,
              toFill: 188.21,
            },
            {
              id: crypto.randomUUID(),
              name: "易方达科创 50 联接 C",
              amount: 19769,
              currentInvest: 0,
              toFill: 197.69,
            },
            {
              id: crypto.randomUUID(),
              name: "德邦稳盈增长灵活配置混合 C",
              amount: 2000,
              currentInvest: 0,
              toFill: 20,
            },
            {
              id: crypto.randomUUID(),
              name: "永赢信息产业智选混合 C",
              amount: 2000,
              currentInvest: 0,
              toFill: -1980,
            },
            {
              id: crypto.randomUUID(),
              name: "北信瑞丰产业升级多策略混合型",
              amount: 9000,
              currentInvest: 0,
              toFill: 90,
            },
          ];

          const cfg =
            window.followConfig && typeof window.followConfig === "object"
              ? window.followConfig
              : null;

          const state = reactive({
            bigTotal: cfg?.bigTotal ?? 350000,
            myTotal: cfg?.myTotal ?? 3500,
            rows: (cfg?.rows ?? demoRows())
              .map((r) => ({
                id: crypto.randomUUID(),
                name: String(r.name ?? ""),
                amount: Number(r.amount) || 0,
                currentInvest: Number(r.currentInvest) || 0,
                color: String(r.color ?? ""),
                toFill: isFinite(r.toFill) ? Number(r.toFill) : null,
              }))
              .sort((a, b) => {
                // 初始化时按占比从大到小排序一次
                const percentA =
                  (Number(a.amount) || 0) / (cfg?.bigTotal ?? 350000);
                const percentB =
                  (Number(b.amount) || 0) / (cfg?.bigTotal ?? 350000);
                return percentB - percentA;
              }),
          });

          // 计算
          const sumAmount = computed(() =>
            state.rows.reduce((s, r) => s + (Number(r.amount) || 0), 0)
          );
          const totalPercentOfBig = computed(() =>
            state.bigTotal > 0 ? sumAmount.value / state.bigTotal : 0
          );
          const ratio = computed(() =>
            state.myTotal > 0 ? state.bigTotal / state.myTotal : null
          );
          const ratioText = computed(() =>
            ratio.value ? ratio.value.toFixed(2) : "—"
          );

          const rowPercent = (row) => {
            const amt = Number(row.amount) || 0;
            return state.bigTotal > 0 ? amt / state.bigTotal : 0;
          };
          // 我应投入 = 大佬该仓位金额 ÷ 倍率
          const shouldInvest = (row) =>
            !ratio.value ? 0 : (Number(row.amount) || 0) / ratio.value;
          // 投入占比 = 我目前投入 ÷ 我的总仓位
          const currentInvestPercent = (row) => {
            const currentInvest = Number(row.currentInvest) || 0;
            return state.myTotal > 0 ? currentInvest / state.myTotal : 0;
          };
          // 待补金额 = 我应投入 - 我目前投入
          const toFillAmount = (row) =>
            shouldInvest(row) - (Number(row.currentInvest) || 0);
          const totalShouldInvest = computed(() =>
            state.rows.reduce((s, r) => s + shouldInvest(r), 0)
          );
          const totalCurrentInvest = computed(() =>
            state.rows.reduce((s, r) => s + (Number(r.currentInvest) || 0), 0)
          );
          const totalToFill = computed(() =>
            state.rows.reduce((s, r) => s + toFillAmount(r), 0)
          );

          // 操作
          const addRow = () => {
            state.rows.push({
              id: crypto.randomUUID(),
              name: "",
              amount: 0,
              currentInvest: 0,
              color: "",
              toFill: null,
            });
          };
          const removeRow = (i) => {
            const sortedRow = sortedRows.value[i];
            const originalIndex = state.rows.findIndex(
              (r) => r.id === sortedRow.id
            );
            const row = state.rows[originalIndex];
            const name = row.name || `第${i + 1}行`;
            if (confirm(`确定要删除"${name}"吗？`)) {
              state.rows.splice(originalIndex, 1);
            }
          };

          // 直接返回原始行数据，不进行动态排序
          const sortedRows = computed(() => {
            return state.rows;
          });

          // 颜色相关函数
          const colorCycle = ["", "#ef4444", "#22c55e", "#3b82f6"]; // 透明、红、绿、蓝

          const toggleColor = (row) => {
            const currentIndex = colorCycle.indexOf(row.color);
            const nextIndex = (currentIndex + 1) % colorCycle.length;
            row.color = colorCycle[nextIndex];
          };

          const getColorClass = (color) => {
            switch (color) {
              case "#ef4444":
                return "red";
              case "#22c55e":
                return "green";
              case "#3b82f6":
                return "blue";
              default:
                return "transparent";
            }
          };

          const getColorTitle = (color) => {
            switch (color) {
              case "#ef4444":
                return "红色";
              case "#22c55e":
                return "绿色";
              case "#3b82f6":
                return "蓝色";
              default:
                return "透明";
            }
          };

          const hexToRgba = (hex, alpha = 1) => {
            if (!hex) return "transparent";
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
          };

          // 复制配置（JS 片段，直接粘到你的代码里）
          const toast = reactive({ show: false, msg: "" });
          const showToast = (msg) => {
            toast.msg = msg;
            toast.show = true;
            setTimeout(() => (toast.show = false), 1300);
          };
          const copyConfig = async () => {
            const payload = {
              bigTotal: state.bigTotal,
              myTotal: state.myTotal,
              rows: state.rows.map((r) => ({
                name: r.name,
                amount: Number(r.amount) || 0,
                currentInvest: Number(r.currentInvest) || 0,
                color: r.color || "",
                toFill: isFinite(r.toFill) ? Number(r.toFill) : null,
              })),
              version: 3,
            };
            const jsSnippet = `
window.followConfig = ${JSON.stringify(payload, null, 2)};`;
            try {
              await navigator.clipboard.writeText(jsSnippet);
              showToast("已复制 JS 配置到剪贴板");
            } catch (e) {
              const ta = document.createElement("textarea");
              ta.value = jsSnippet;
              document.body.appendChild(ta);
              ta.select();
              document.execCommand("copy");
              ta.remove();
              showToast("已复制 JS 配置（兼容模式）");
            }
          };

          // 工具
          const nf = new Intl.NumberFormat("zh-CN", {
            maximumFractionDigits: 2,
          });
          const pf = new Intl.NumberFormat("zh-CN", {
            style: "percent",
            maximumFractionDigits: 2,
          });
          const fmt = (n) => nf.format(Number(n || 0));
          const pct = (p) => pf.format(Math.max(0, p || 0));

          return {
            state,
            sumAmount,
            totalPercentOfBig,
            ratioText,
            totalShouldInvest,
            totalCurrentInvest,
            totalToFill,
            rowPercent,
            shouldInvest,
            currentInvestPercent,
            toFillAmount,
            sortedRows,
            addRow,
            removeRow,
            toggleColor,
            getColorClass,
            getColorTitle,
            hexToRgba,
            copyConfig,
            toast,
            fmt,
            pct,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
